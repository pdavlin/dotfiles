# ============================================
# ~/.zshrc - Optimized for Linux & macOS
# Managed by chezmoi
# ============================================

# ============================================
# Plugin Management (no OMZ - 200ms faster)
# ============================================

# Initialize completion system (needed for some plugins)
autoload -Uz compinit && compinit

# Async library (for git prompt if you want it later)
[[ -f ~/.config/zsh/plugins/zsh-async/async.zsh ]] && \
    source ~/.config/zsh/plugins/zsh-async/async.zsh

# Syntax highlighting (colorizes commands as you type)
[[ -f ~/.config/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]] && \
    source ~/.config/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

# Autosuggestions (shows command suggestions)
[[ -f ~/.config/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh ]] && \
    source ~/.config/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh

# NPM scripts autocomplete (Tab completion for package.json scripts)
[[ -f ~/.config/zsh/plugins/zsh-npm-scripts-autocomplete/zsh-npm-scripts-autocomplete.plugin.zsh ]] && \
    source ~/.config/zsh/plugins/zsh-npm-scripts-autocomplete/zsh-npm-scripts-autocomplete.plugin.zsh

# FZF tab completion (replaces default tab completion with fzf)
[[ -f ~/.config/zsh/plugins/fzf-tab/fzf-tab.plugin.zsh ]] && \
    source ~/.config/zsh/plugins/fzf-tab/fzf-tab.plugin.zsh

# Z for directory jumping
[[ -f ~/z.sh ]] && source ~/z.sh

# ============================================
# FZF Tab Configuration
# ============================================

# FZF Tab Configuration
if [[ -f ~/.config/zsh/plugins/fzf-tab/fzf-tab.plugin.zsh ]]; then
    # disable sort when completing `git checkout`
    zstyle ':completion:*:git-checkout:*' sort false
    # set descriptions format to enable group support
    zstyle ':completion:*:descriptions' format '[%d]'
    # preview directory's content with eza when completing cd
    if command -v eza &>/dev/null; then
        zstyle ':fzf-tab:complete:cd:*' fzf-preview 'eza -1 --color=always $realpath'
    else
        zstyle ':fzf-tab:complete:cd:*' fzf-preview 'ls --color=always $realpath'
    fi
fi

# ============================================
# Environment Variables
# ============================================
export TERM="xterm-256color"
export EDITOR='nvim'
export VISUAL='nvim'
export MANPAGER='nvim +Man!'
export MANWIDTH=999

# ============================================
# Path Configuration (using zsh array for uniqueness)
# ============================================
typeset -U path PATH  # Ensure unique entries

# Function to safely prepend to PATH
path_prepend() {
    [ -d "$1" ] && path=("$1" $path)
}

# Core paths
path_prepend "$HOME/.local/bin"
path_prepend "$HOME/bin"

# ============================================
# History Configuration
# ============================================
HISTFILE="$HOME/.zsh_history"
HISTSIZE=100000
SAVEHIST=100000
setopt EXTENDED_HISTORY
setopt HIST_EXPIRE_DUPS_FIRST
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_VERIFY
setopt INC_APPEND_HISTORY
setopt SHARE_HISTORY

# ============================================
# Aliases
# ============================================
alias zshconfig="$EDITOR ~/.zshrc"
alias ohmyzsh="$EDITOR ~/.oh-my-zsh"
alias c='clear'
alias vim='nvim'
command -v bat &>/dev/null && alias cat='bat'  # Only if bat is installed

# Navigation aliases
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias .....='cd ../../../..'

# Git aliases
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gl='git log --oneline --graph'

# ============================================
# Tool Initialization
# ============================================

# 1Password CLI (cross-platform)
[ -f "$HOME/.config/op/plugins.sh" ] && source "$HOME/.config/op/plugins.sh"

# FZF (platform-specific paths)
{{ if eq .chezmoi.os "darwin" -}}
[ -f "/opt/homebrew/opt/fzf/shell/key-bindings.zsh" ] && \
    source "/opt/homebrew/opt/fzf/shell/key-bindings.zsh"
{{- else if eq .chezmoi.os "linux" -}}
[ -f "/usr/share/fzf/shell/key-bindings.zsh" ] && \
    source "/usr/share/fzf/shell/key-bindings.zsh"
[ -f "$HOME/.fzf/shell/key-bindings.zsh" ] && \
    source "$HOME/.fzf/shell/key-bindings.zsh"
{{- end }}

# Starship prompt (if installed)
if command -v starship &>/dev/null; then
    eval "$(starship init zsh)"
fi

# ============================================
# JavaScript Runtime Configuration
# ============================================

{{ if eq .chezmoi.os "darwin" -}}
# Bun (macOS preference)
if [ -d "$HOME/.bun" ]; then
    export BUN_INSTALL="$HOME/.bun"
    path_prepend "$BUN_INSTALL/bin"
    [ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"
fi
{{- end }}

# NVM (lazy-loaded for performance)
export NVM_DIR="$HOME/.nvm"
# Lazy load NVM to improve shell startup time
nvm() {
    unset -f nvm node npm npx
    [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
    [ -s "$NVM_DIR/bash_completion" ] && source "$NVM_DIR/bash_completion"
    nvm "$@"
}
# Create shims for common commands
node() { nvm; node "$@"; }
npm() { nvm; npm "$@"; }
npx() { nvm; npx "$@"; }

# PNPM (cross-platform)
if [ -d "$HOME/.local/share/pnpm" ]; then
    export PNPM_HOME="$HOME/.local/share/pnpm"
    path_prepend "$PNPM_HOME"
fi

# ============================================
# Go Configuration
# ============================================
if command -v go &>/dev/null; then
    export GOPATH="$HOME/go"
    path_prepend "$GOPATH/bin"
fi

# ============================================
# Platform-Specific Configuration
# ============================================

{{ if eq .chezmoi.os "darwin" -}}
# === macOS Specific ===

# Homebrew
[ -f "/opt/homebrew/bin/brew" ] && eval "$(/opt/homebrew/bin/brew shellenv)"

# macOS aliases
alias ls='ls -G'
alias ll='ls -lhG'
alias la='ls -lahG'

{{- else if eq .chezmoi.os "linux" -}}
# === Linux Specific ===

# Systemd aliases
alias sc='systemctl'
alias scu='systemctl --user'
alias jc='journalctl'
alias jcu='journalctl --user'

# Linux aliases
alias ls='ls --color=auto'
alias ll='ls -lh --color=auto'
alias la='ls -lah --color=auto'

# Flatpak (for Bluefin/Silverblue)
if [ -d "/var/lib/flatpak" ]; then
    path_prepend "/var/lib/flatpak/exports/bin"
    path_prepend "$HOME/.local/share/flatpak/exports/bin"
fi

# ACME.sh (Let's Encrypt)
[ -f "$HOME/.acme.sh/acme.sh.env" ] && source "$HOME/.acme.sh/acme.sh.env"

{{- end }}

# ============================================
# Shell Enhancement Tools
# ============================================

# Zoxide (better cd)
command -v zoxide &>/dev/null && eval "$(zoxide init zsh)"

# Atuin (better history)
if [ -f "$HOME/.atuin/bin/env" ]; then
    source "$HOME/.atuin/bin/env"
    command -v atuin &>/dev/null && eval "$(atuin init zsh)"
fi

# ============================================
# Local Overrides
# ============================================
# Source local configuration if it exists
[ -f "$HOME/.zshrc.local" ] && source "$HOME/.zshrc.local"

# ============================================
# Performance Monitoring (optional)
# ============================================
# Uncomment to debug slow startup
# zprof  # Run zprof at end to see what's taking time

# ============================================
# Cleanup
# ============================================
# Export the final PATH
export PATH
